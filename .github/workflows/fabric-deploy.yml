name: Microsoft Fabric Deploy

on:
  workflow_call:
    inputs:
      workspace_id:
        description: 'Microsoft Fabric workspace ID'
        required: true
        type: string
      source_directory:
        description: 'Directory with Fabric artifacts to deploy'
        required: false
        type: string
        default: './fabric'
      environment:
        description: 'Target environment (dev|staging|prod)'
        required: true
        type: string
      deploy_mode:
        description: 'Deployment mode'
        required: false
        type: string
        default: 'full'
      unpublish_orphan_items:
        description: 'Unpublish orphan items from the workspace'
        required: false
        type: boolean
        default: true
      standardize_default_lakehouse:
        description: 'Standardize default lakehouse references before deployment'
        required: false
        type: boolean
        default: true
      update_deployment_tag:
        description: 'Create/update deployment tag for incremental tracking'
        required: false
        type: boolean
        default: true
      dry_run:
        description: 'Perform a dry run without making changes'
        required: false
        type: boolean
        default: false
      verbose:
        description: 'Enable verbose (debug-level) output.'
        required: false
        type: boolean
        default: false
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_TENANT_ID:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: write  # needed to push tags

    steps:
      - name: 📥 Checkout repository (app/artifacts)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📥 Checkout fabric-deploy workflow repo
        uses: actions/checkout@v4
        with:
          repository: olepetter-no/fabric-deploy-workflow
          path: .fabric-deploy-workflow
          ref: main

      - name: 🐍 Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 📝 Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: 💾 Cache Poetry venv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .fabric-deploy-workflow/.venv
          key: venv-${{ runner.os }}-${{ inputs.python_version }}-${{ hashFiles('.fabric-deploy-workflow/poetry.lock') }}

      - name: 📦 Install dependencies
        working-directory: .fabric-deploy-workflow
        run: |
          poetry install --only main --no-interaction --no-ansi

      - name: 🔍 Validate configuration
        working-directory: .fabric-deploy-workflow
        run: |
          echo "Validating configuration..."
          poetry run python -m fabric_deploy validate \
            --workspace-id "${{ inputs.workspace_id }}" \
            --source-directory "../${{ inputs.source_directory }}" \
            --environment "${{ inputs.environment }}"

      - name: ⚙️ Configure git identity (for tag pushes)
        if: ${{ !inputs.dry_run && inputs.update_deployment_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: 🚀 Deploy to Microsoft Fabric
        working-directory: .fabric-deploy-workflow
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          echo "Deploying (mode=${{ inputs.deploy_mode }}, env=${{ inputs.environment }})"
          poetry run python -m fabric_deploy deploy \
            --workspace-id "${{ inputs.workspace_id }}" \
            --source-directory "../${{ inputs.source_directory }}" \
            --environment "${{ inputs.environment }}" \
            --deploy-mode "${{ inputs.deploy_mode }}" \
            ${{ inputs.dry_run && '--dry-run' || '' }} \
            ${{ inputs.unpublish_orphan_items && '--unpublish-orphan-items' || '' }} \
            ${{ inputs.standardize_default_lakehouse && '--standardize-default-lakehouse' || '' }} \
            ${{ inputs.update_deployment_tag && '--update-deployment-tag' || '--no-update-deployment-tag' }} \
            ${{ inputs.verbose && '--verbose' || '' }}

      - name: 🏷️ Push deployment tag
        if: ${{ !inputs.dry_run && inputs.update_deployment_tag }}
        run: |
          set -euo pipefail

          # Only touch the tag that matches the current environment
          SELF_TAG="latestDeployed/${{ inputs.environment }}"

          # If the CLI didn't create the tag locally, there's nothing to push
          if ! git rev-parse -q --verify "refs/tags/$SELF_TAG" >/dev/null; then
            echo "No local tag '$SELF_TAG' to push. Nothing to do."
            exit 0
          fi

          echo "Force-updating remote tag: $SELF_TAG"
          # Delete remote tag if it exists, ignore error if it doesn't
          git push origin ":refs/tags/$SELF_TAG" >/dev/null 2>&1 || true
          # Push the local tag
          git push origin "$SELF_TAG"

      - name: ✅ Summary
        if: always()
        run: |
          echo "Fabric deploy :: env=${{ inputs.environment }} mode=${{ inputs.deploy_mode }} dry_run=${{ inputs.dry_run }}"
